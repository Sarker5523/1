<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Video Details</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.5.2/flowbite.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="styles.css">
</head>
<body class="bg-gray-900">

  <!-- Navbar -->
  <nav class="bg-white border-gray-200 dark:bg-gray-900">
    <div class="max-w-screen-xl flex flex-wrap items-center justify-between mx-auto p-4">
      <a href="index.html" class="flex items-center space-x-3 rtl:space-x-reverse">
        <img src="https://flowbite.com/docs/images/logo.svg" class="h-8 w-auto" alt="VideoHub Logo" />
        <span class="self-center text-2xl font-semibold whitespace-nowrap dark:text-white">VideoHub</span>
      </a>
      <div class="flex md:order-2 space-x-3 rtl:space-x-reverse">
        <button type="button" data-collapse-toggle="navbar-search" aria-controls="navbar-search"
                class="md:hidden text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-4 focus:ring-green-300 rounded-lg text-sm p-2.5 me-2">
          <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20">
            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="m19 19-4-4m0-7A7 7 0 1 1 1 8a7 7 0 0 1 14 0Z"/>
          </svg>
        </button>
        <div class="relative hidden md:block">
          <div class="absolute inset-y-0 start-0 flex items-center ps-3 pointer-events-none">
            <svg class="w-4 h-4 text-gray-500 dark:text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20">
              <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="m19 19-4-4m0-7A7 7 0 1 1 1 8a7 7 0 0 1 14 0Z"/>
            </svg>
          </div>
          <input type="text" id="search-navbar"
                 class="block w-full p-2 ps-10 text-sm text-gray-900 border border-gray-300 rounded-lg bg-gray-50 focus:ring-green-500 focus:border-green-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-green-500 dark:focus:border-green-500"
                 placeholder="Search videos, performers, studios..." oninput="debouncedSearch()" onkeydown="handleEnter(event)">
          <div id="search-suggestions" class="search-suggestions hidden"></div>
        </div>
        <button data-collapse-toggle="navbar-search" type="button"
                class="inline-flex items-center p-2 w-10 h-10 justify-center text-sm text-gray-500 rounded-lg md:hidden hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-200 dark:text-gray-400 dark:hover:bg-gray-700 dark:focus:ring-gray-600">
          <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 17 14">
            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M1 1h15M1 7h15M1 13h15"/>
          </svg>
        </button>
      </div>
      <div class="items-center justify-between hidden w-full md:flex md:w-auto md:order-1" id="navbar-search">
        <div class="relative mt-3 md:hidden">
          <div class="absolute inset-y-0 start-0 flex items-center ps-3 pointer-events-none">
            <svg class="w-4 h-4 text-gray-500 dark:text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20">
              <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="m19 19-4-4m0-7A7 7 0 1 1 1 8a7 7 0 0 1 14 0Z"/>
            </svg>
          </div>
          <input type="text" id="search-navbar-mobile"
                 class="block w-full p-2 ps-10 text-sm text-gray-900 border border-gray-300 rounded-lg bg-gray-50 focus:ring-green-500 focus:border-green-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-green-500 dark:focus:border-green-500"
                 placeholder="Search..." oninput="debouncedSearch()" onkeydown="handleEnter(event)">
          <div id="search-suggestions-mobile" class="search-suggestions hidden"></div>
        </div>
        <ul class="flex flex-col p-4 md:p-0 mt-4 font-medium border border-gray-100 rounded-lg bg-gray-50 md:space-x-8 md:flex-row md:mt-0 md:border-0 md:bg-white dark:bg-gray-800 md:dark:bg-gray-900 dark:border-gray-700">
          <li><a href="index.html" class="block py-2 px-3 text-white bg-green-700 rounded md:bg-transparent md:text-green-700 md:p-0">Home</a></li>
          <li><a href="studio.html" class="block py-2 px-3 text-gray-900 rounded hover:bg-gray-100 md:hover:bg-transparent md:hover:text-green-700 md:p-0 dark:text-white dark:hover:bg-gray-700">Studio</a></li>
          <li><a href="performer.html" class="block py-2 px-3 text-gray-900 rounded hover:bg-gray-100 md:hover:bg-transparent md:hover:text-green-700 md:p-0 dark:text-white dark:hover:bg-gray-700">Performers</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Video Content -->
  <div class="content-wrapper max-w-4xl mx-auto p-4">
    <div id="video-details"></div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.5.2/flowbite.min.js"></script>
  <script>
    const CACHE_TTL = 24 * 60 * 60 * 1000;
    let db = null;
    let searchTimeout;

    const searchInput            = document.getElementById('search-navbar');
    const searchInputMobile      = document.getElementById('search-navbar-mobile');
    const searchSuggestions      = document.getElementById('search-suggestions');
    const searchSuggestionsMobile = document.getElementById('search-suggestions-mobile');
    const videoDetails           = document.getElementById('video-details');

    // ---------- IndexedDB ----------
    async function initDB() {
      try {
        return await new Promise((res, rej) => {
          const req = indexedDB.open('VideoHubCache', 1);
          req.onerror = () => rej(req.error);
          req.onsuccess = () => { db = req.result; res(db); };
          req.onupgradeneeded = e => {
            const db = e.target.result;
            if (!db.objectStoreNames.contains('videos'))
              db.createObjectStore('videos', { keyPath: 'id' });
          };
        });
      } catch (e) { console.warn('DB init failed', e); }
    }

    async function getCache(id) {
      if (!db || !id) return null;
      return new Promise(res => {
        const tx = db.transaction('videos', 'readonly');
        const store = tx.objectStore('videos');
        const req = store.get(id);
        req.onsuccess = () => {
          const d = req.result;
          res(d && Date.now() - d.ts < CACHE_TTL ? d.payload : null);
        };
        req.onerror = () => res(null);
      });
    }

    async function putCache(id, payload) {
      if (!db || !id) return;
      const tx = db.transaction('videos', 'readwrite');
      tx.objectStore('videos').put({ id, payload, ts: Date.now() });
    }

    // ---------- Load JSON ----------
    async function loadSceneDetails() {
      try {
        const res = await fetch('scene_details.json');
        if (!res.ok) throw new Error('scene_details.json not found');
        return await res.json();
      } catch (e) {
        videoDetails.innerHTML = `<p class="text-red-400 p-4">Error: ${e.message}</p>`;
        return [];
      }
    }

    // ---------- Performers – FIXED ----------
    function extractPerformers(performers) {
      if (!performers) return [];

      // Accept both: array of objects **or** a single object
      const names = new Set();

      if (Array.isArray(performers)) {
        performers.forEach(p => p?.name?.trim() && names.add(p.name.trim()));
      } else if (performers.name) {
        names.add(performers.name.trim());
      }

      return Array.from(names);
    }

    // ---------- Studio chain ----------
    function buildStudioChain(site) {
      const seen = new Set();
      const parts = [];

      if (site?.name && !seen.has(site.name)) {
        seen.add(site.name);
        parts.push({ name: site.name, id: site._id || 0 });
      }
      if (site?.network?.name && !seen.has(site.network.name)) {
        seen.add(site.network.name);
        parts.push({ name: site.network.name, id: 0 });
      }
      if (site?.parent?.name && !seen.has(site.parent.name)) {
        seen.add(site.parent.name);
        parts.push({ name: site.parent.name, id: 0 });
      }
      return parts.length ? parts : [{ name: 'Unknown Studio', id: 0 }];
    }

    // ---------- Load video ----------
    async function loadVideo() {
      const params = new URLSearchParams(location.search);
      const id = params.get('id');
      if (!id) { videoDetails.innerHTML = '<p class="text-red-400">No video ID</p>'; return; }

      const cached = await getCache(id);
      if (cached) { renderVideo(cached); return; }

      const scenes = await loadSceneDetails();
      const scene = scenes.find(s => String(s.data?._id) === id);
      if (!scene) { videoDetails.innerHTML = '<p class="text-red-400">Video not found</p>'; return; }

      const performers = extractPerformers(scene.data?.performers);
      const studioChain = buildStudioChain(scene.data?.site);

      const payload = {
        id: String(scene.data._id),
        title: (scene.data.title || 'Untitled').trim(),
        description: scene.data.description || 'No description.',
        thumbnail: scene.data.background?.full || 'https://via.placeholder.com/300x200?text=No+Image',
        trailer: scene.data.trailer || '',
        videoIdForEmbed: scene.video_Id?.trim() || 'pupt5r',
        performers: performers,
        studioChain: studioChain
      };

      await putCache(id, payload);
      renderVideo(payload);
    }

    // ---------- Render Video ----------
    function renderVideo(v) {
      const performersHtml = (v.performers || []).length
        ? v.performers.map(p => `
            <a href="performer.html?name=${encodeURIComponent(p)}" class="text-green-400 hover:underline">
              ${p}
            </a>
          `).join(', ')
        : '<span class="text-gray-500">Unknown</span>';

      const studioHtml = (v.studioChain || [])
        .map((s, i) => {
          if (s.id && i === 0) {
            return `<a href="site.html?id=${s.id}" class="text-green-400 hover:underline">${s.name}</a>`;
          }
          return `<span class="text-green-400">${s.name}</span>`;
        })
        .join(' → ');

      videoDetails.innerHTML = `
        <div class="video-embed mb-6 aspect-video bg-black rounded-lg overflow-hidden">
          <iframe src="https://purn.upn.one/#${v.videoIdForEmbed}"
                  class="w-full h-full" frameborder="0"
                  allow="fullscreen; autoplay; encrypted-media; picture-in-picture">
          </iframe>
        </div>

        <h1 class="text-2xl md:text-3xl font-bold text-white mb-3">${v.title}</h1>
        <p class="text-gray-300 mb-4 leading-relaxed">${v.description}</p>
        <p class="text-sm text-gray-400 mb-1">Studio: ${studioHtml}</p>
        <p class="text-sm text-gray-400 mb-6">Performers: ${performersHtml}</p>

        ${v.trailer ? `
          <video controls poster="${v.thumbnail}" class="w-full rounded-lg mb-4">
            <source src="${v.trailer}" type="video/mp4">
            Your browser does not support video.
          </video>
        ` : ''}
      `;
    }

    // ---------- Search Index ----------
    async function ensureSearchIndex() {
      if (localStorage.getItem('searchIndex')) return;
      const scenes = await loadSceneDetails();
      const index = scenes.map(s => {
        const performers = extractPerformers(s.data?.performers);
        return {
          id: String(s.data._id),
          title: (s.data.title || '').trim(),
          thumbnail: s.data.background?.full || '',
          performers: performers
        };
      });
      localStorage.setItem('searchIndex', JSON.stringify(index));
    }

    function debouncedSearch() {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(handleSearch, 300);
    }

    async function handleSearch() {
      const q = (searchInput?.value || searchInputMobile?.value || '').trim().toLowerCase();
      if (!q) { hideSuggestions(); return; }

      await ensureSearchIndex();
      const index = JSON.parse(localStorage.getItem('searchIndex') || '[]');
      const results = index
        .filter(v => v.title.toLowerCase().includes(q) || v.performers.some(p => p.toLowerCase().includes(q)))
        .slice(0, 5);

      renderSuggestions(searchSuggestions, results);
      renderSuggestions(searchSuggestionsMobile, results);
    }

    function renderSuggestions(container, list) {
      container.innerHTML = list.length
        ? list.map(v => `
            <div class="flex items-center p-2 cursor-pointer hover:bg-gray-700 rounded" onclick="location.href='video.html?id=${v.id}'">
              <img src="${v.thumbnail || 'https://via.placeholder.com/40x40'}" class="w-10 h-10 rounded object-cover mr-3">
              <div class="flex-1 min-w-0">
                <div class="text-sm text-white truncate">${v.title}</div>
                <div class="text-xs text-green-400">${v.performers.join(', ')}</div>
              </div>
            </div>
          `).join('')
        : '<div class="p-2 text-sm text-gray-400">No results</div>';
      container.classList.toggle('hidden', list.length === 0);
    }

    function hideSuggestions() {
      searchSuggestions.classList.add('hidden');
      searchSuggestionsMobile.classList.add('hidden');
    }

    function handleEnter(e) {
      if (e.key === 'Enter') {
        const q = (searchInput?.value || searchInputMobile?.value || '').trim();
        if (q) location.href = `search.html?query=${encodeURIComponent(q)}`;
      }
    }

    function syncInputs(src) {
      if (src === searchInput && searchInputMobile) searchInputMobile.value = src.value;
      if (src === searchInputMobile && searchInput) searchInput.value = src.value;
    }

    // ---------- Init ----------
    initDB().then(() => {
      loadVideo();
      ensureSearchIndex();
    }).catch(() => {
      loadVideo();
      ensureSearchIndex();
    });

    searchInput?.addEventListener('input', () => { debouncedSearch(); syncInputs(searchInput); });
    searchInputMobile?.addEventListener('input', () => { debouncedSearch(); syncInputs(searchInputMobile); });
    document.addEventListener('keydown', handleEnter);
  </script>
</body>
</html>
