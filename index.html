<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- BRAVE-SAFE CSP -->
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com;
    style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com https://fonts.googleapis.com;
    font-src https://fonts.gstatic.com;
    img-src 'self' https:;
    media-src 'self' https:;
    connect-src 'self' https:;
  ">

  <title>VideoHub</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.5.2/flowbite.min.css" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
</head>
<body>

  <!-- FORCE LAZY LOAD (Brave iOS ignores loading="lazy" without JS) -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('img').forEach(img => {
        img.loading = 'lazy';
      });
    });
  </script>

  <!-- NAVBAR (unchanged) -->
  <nav>
    <div class="max-w-screen-xl flex flex-wrap items-center justify-between mx-auto p-4">
      <a href="index.html" class="flex items-center space-x-3">
        <img src="https://flowbite.com/docs/images/logo.svg" class="h-8 w-auto" alt="VideoHub Logo">
        <span class="self-center text-2xl font-semibold whitespace-nowrap">VideoHub</span>
      </a>
      <div class="flex md:order-2 space-x-3">
        <button type="button" data-collapse-toggle="navbar-search" aria-controls="navbar-search"
                class="md:hidden text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-4 focus:ring-green-300 rounded-lg text-sm p-2.5">
          <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20">
            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="m19 19-4-4m0-7A7 7 0 1 1 1 8a7 7 0 0 1 14 0Z"/>
          </svg>
        </button>
        <div class="relative hidden md:block">
          <div class="absolute inset-y-0 start-0 flex items-center ps-3 pointer-events-none">
            <svg class="w-4 h-4 text-gray-500 dark:text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20">
              <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="m19 19-4-4m0-7A7 7 0 1 1 1 8a7 7 0 0 1 14 0Z"/>
            </svg>
          </div>
          <input type="text" id="search-navbar"
                 class="block w-full p-2 ps-10 text-sm text-gray-900 border border-gray-300 rounded-lg bg-gray-50 focus:ring-green-500 focus:border-green-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-green-500 dark:focus:border-green-500"
                 placeholder="Search videos, performers, studios..." oninput="debouncedSearch()">
          <div id="search-suggestions" class="search-suggestions hidden z-50 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-b-lg shadow-lg"></div>
        </div>
        <button data-collapse-toggle="navbar-search" type="button"
                class="inline-flex items-center p-2 w-10 h-10 justify-center text-sm text-gray-500 rounded-lg md:hidden hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-200 dark:text-gray-400 dark:hover:bg-gray-700 dark:focus:ring-gray-600">
          <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 17 14">
            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M1 1h15M1 7h15M1 13h15"/>
          </svg>
        </button>
      </div>
      <div class="items-center justify-between hidden w-full md:flex md:w-auto md:order-1" id="navbar-search">
        <div class="relative mt-3 md:hidden">
          <div class="absolute inset-y-0 start-0 flex items-center ps-3 pointer-events-none">
            <svg class="w-4 h-4 text-gray-500 dark:text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20">
              <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="m19 19-4-4m0-7A7 7 0 1 1 1 8a7 7 0 0 1 14 0Z"/>
            </svg>
          </div>
          <input type="text" id="search-navbar-mobile"
                 class="block w-full p-2 ps-10 text-sm text-gray-900 border border-gray-300 rounded-lg bg-gray-50 focus:ring-green-500 focus:border-green-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-green-500 dark:focus:border-green-500"
                 placeholder="Search..." oninput="debouncedSearch()">
          <div id="search-suggestions-mobile" class="search-suggestions hidden z-50 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-b-lg shadow-lg"></div>
        </div>
        <ul class="flex flex-col p-4 md:p-0 mt-4 font-medium border border-gray-100 rounded-lg bg-gray-50 md:space-x-8 md:flex-row md:mt-0 md:border-0 md:bg-white dark:bg-gray-800 md:dark:bg-gray-900 dark:border-gray-700">
          <li><a href="index.html" class="block py-2 px-3 text-white bg-green-700 rounded md:bg-transparent md:text-green-700 md:p-0">Home</a></li>
          <li><a href="studio.html" class="block py-2 px-3 text-gray-900 rounded hover:bg-gray-100 md:hover:bg-transparent md:hover:text-green-700 md:p-0 dark:text-white dark:hover:bg-gray-700">Studio</a></li>
          <li><a href="performer.html" class="block py-2 px-3 text-gray-900 rounded hover:bg-gray-100 md:hover:bg-transparent md:hover:text-green-700 md:p-0 dark:text-white dark:hover:bg-gray-700">Performers</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="pagination" id="pagination-top"></div>
  <div class="video-list-container">
    <div class="video-list" id="video-list"></div>
  </div>
  <div class="pagination" id="pagination-bottom"></div>

  <!-- DEFERRED SCRIPTS -->
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.5.2/flowbite.min.js"></script>
  <script defer>
    // ------------------------------------------------------------
    // STATE
    // ------------------------------------------------------------
    const PER_PAGE = 12;
    let all = [], filtered = [], page = 1;
    const params = new URLSearchParams(location.search);
    if (params.has('page')) page = Math.max(1, +params.get('page'));

    const list = document.getElementById('video-list');
    const pagT = document.getElementById('pagination-top');
    const pagB = document.getElementById('pagination-bottom');
    const inp = document.getElementById('search-navbar');
    const inpM = document.getElementById('search-navbar-mobile');
    const sug = document.getElementById('search-suggestions');
    const sugM = document.getElementById('search-suggestions-mobile');

    let perfMap = {}, timeout, searchPromise;

    // ------------------------------------------------------------
    // LOAD + ERROR UI
    // ------------------------------------------------------------
    async function load() {
      try {
        const [scenes, perfs] = await Promise.all([
          fetch('scene_details.json', { signal: AbortSignal.timeout(8000) }).then(r => r.ok ? r.json() : []),
          fetch('performer.json', { signal: AbortSignal.timeout(8000) }).then(r => r.ok ? r.json() : [])
        ]);

        perfs.forEach(p => { if (p._id) perfMap[p._id] = p; });

        all = scenes.map(s => {
          const d = s.data || {};
          const ps = d.performers || [];
          const arr = Array.isArray(ps) ? ps : (ps?.parent ? [ps] : []);

          let actress = 'Unknown';
          const ids = [];
          for (const p of arr) {
            const id = p?.parent?._id;
            if (id) {
              ids.push(id);
              const full = perfMap[id];
              if (full && (full.extras?.gender === 'Female' || !full.extras?.gender)) {
                actress = full.name || 'Unknown';
                break;
              }
            }
          }

          return {
            id: d._id || '',
            title: (d.title?.trim()) || 'Untitled',
            thumb: d.background?.full || 'https://via.placeholder.com/300x200?text=No+Image',
            actress,
            perfIds: ids
          };
        }).reverse();

        filtered = [...all];
        render();
      } catch (e) {
        list.innerHTML = `<p class="text-red-500 p-4">Failed to load data. Try Safari or check files.</p>`;
        console.error(e);
      }
    }

    // ------------------------------------------------------------
    // RENDER
    // ------------------------------------------------------------
    function render() {
      const start = (page-1)*PER_PAGE;
      const end = start + PER_PAGE;
      const slice = filtered.slice(start, end);

      list.innerHTML = slice.length
        ? slice.map(v => `
          <div class="video-item">
            <a href="video.html?id=${v.id}">
              <img src="${v.thumb}" alt="${esc(v.title)}" loading="lazy"
                   onerror="this.src='https://via.placeholder.com/300x200?text=No+Image'"
                   class="w-full h-auto object-cover rounded">
              <h3 class="line-clamp-2">${esc(v.title)}</h3>
              <div class="actress-box">${esc(v.actress)}</div>
            </a>
          </div>`).join('')
        : '<p class="text-gray-400 p-4">No videos found.</p>';

      renderPag();
    }

    function renderPag() {
      const total = Math.ceil(filtered.length / PER_PAGE);
      [pagT, pagB].forEach(c => {
        c.innerHTML = '';
        if (total <= 1) return;

        const max = 5;
        let s = Math.max(1, page - Math.floor(max/2));
        let e = Math.min(total, s + max - 1);
        if (e - s < max-1) s = Math.max(1, e - max + 1);

        const btn = (p,t,dis=false,act=false) => {
          const a = Object.assign(document.createElement('a'), {
            href: dis ? '#' : `index.html?page=${p}`,
            textContent: t,
            className: `px-3 py-2 text-sm font-medium rounded-md ${act?'bg-green-700 text-white':'text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800'} ${dis?'opacity-50 cursor-not-allowed':''}`
          });
          return a;
        };

        if (page>1) c.appendChild(btn(page-1,'Prev'));
        for (let i=s; i<=e; i++) c.appendChild(btn(i,i,false,i===page));
        if (page<total) c.appendChild(btn(page+1,'Next'));
      });
    }

    // ------------------------------------------------------------
    // SEARCH (cancelable)
    // ------------------------------------------------------------
    function debouncedSearch() {
      if (searchPromise) searchPromise.ignore = true;
      clearTimeout(timeout);
      timeout = setTimeout(() => {
        const p = search();
        searchPromise = p;
        p.finally(() => { if (searchPromise === p) searchPromise = null; });
      }, 350);
    }

    async function search() {
      const q = (inp?.value || inpM?.value || '').trim().toLowerCase();
      hideSug();

      if (!q) {
        if (searchPromise?.ignore) return;
        filtered = [...all]; page = 1; render(); return;
      }

      filtered = all.filter(v => {
        if (searchPromise?.ignore) return false;
        return v.title.toLowerCase().includes(q) ||
               v.actress.toLowerCase().includes(q) ||
               v.perfIds.some(id => perfMap[id]?.name?.toLowerCase().includes(q));
      });

      if (searchPromise?.ignore) return;
      page = 1; render(); showSug(q);
    }

    function showSug(q) {
      const hits = all.filter(v => v.title.toLowerCase().includes(q) || v.actress.toLowerCase().includes(q)).slice(0,6);
      const html = hits.length
        ? hits.map(v => `
          <div class="flex items-center p-2 hover:bg-gray-100 dark:hover:bg-gray-800 cursor-pointer"
               onclick="location.href='video.html?id=${v.id}'">
            <img src="${v.thumb}" alt="${esc(v.title)}" loading="lazy"
                 class="w-10 h-10 object-cover rounded mr-2"
                 onerror="this.src='https://via.placeholder.com/40x40?text=No+Image'">
            <div class="flex-1 min-w-0">
              <div class="text-sm font-medium truncate">${esc(v.title)}</div>
              <div class="text-xs text-green-400">${esc(v.actress)}</div>
            </div>
          </div>`).join('')
        : '<div class="p-2 text-sm text-gray-400">No results</div>';

      [sug, sugM].forEach(el => {
        el.innerHTML = html;
        el.classList.toggle('hidden', !hits.length);
      });
    }

    function hideSug() { [sug, sugM].forEach(e => e.classList.add('hidden')); }

    function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

    // ------------------------------------------------------------
    // INPUT SYNC
    // ------------------------------------------------------------
    inp?.addEventListener('input', () => { if (inpM) inpM.value = inp.value; debouncedSearch(); });
    inpM?.addEventListener('input', () => { if (inp) inp.value = inpM.value; debouncedSearch(); });

    document.addEventListener('keydown', e => {
      if (e.key === 'Enter' && (document.activeElement === inp || document.activeElement === inpM)) {
        const q = (inp?.value || inpM?.value || '').trim();
        if (q) location.href = `search.html?query=${encodeURIComponent(q)}`;
      }
    });

    // ------------------------------------------------------------
    // START
    // ------------------------------------------------------------
    load();
  </script>
</body>
</html>
