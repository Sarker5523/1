<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Video Details</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>

  <header>
    <div class="home-btn" onclick="window.location.href='index.html'">Home</div>
    <div class="title-container">
      <h1>Video Details</h1>
      <div class="play-button"></div>
    </div>
    <input type="text" id="search-input" class="search-bar" placeholder="Search..." oninput="handleSearch()" onkeydown="handleEnter(event)">
    <div id="search-suggestions" class="search-suggestions"></div>
  </header>

  <div class="video-details-container">
    <video id="video-player" controls>
      <source id="video-source" src="" type="video/mp4">
      Your browser does not support the video tag.
    </video>
    <h2 id="video-title"></h2>
    <p id="video-details"></p>
    <p id="video-category"></p>
    <p id="actor-category"></p>
  </div>

  <div class="related-videos-container">
    <h3>Related Videos</h3>
    <div class="video-grid" id="related-videos-grid"></div>
  </div>

  <script>
    const videoPlayer = document.getElementById('video-player');
    const videoSource = document.getElementById('video-source');
    const videoTitle = document.getElementById('video-title');
    const videoDetails = document.getElementById('video-details');
    const videoCategory = document.getElementById('video-category');
    const actorCategory = document.getElementById('actor-category');
    const relatedVideosGrid = document.getElementById('related-videos-grid');

    const urlParams = new URLSearchParams(window.location.search);
    const videoId = urlParams.get('id');

    function fetchVideoDetails() {
      fetch('https://raw.githubusercontent.com/Sarker5523/My-Playlists/main/video.csv')
        .then(response => response.text())
        .then(text => {
          const videos = parseCSV(text);
          const video = videos.find(v => v.id === videoId);

          if (video) {
            videoSource.src = video.embed_code;
            videoTitle.textContent = video.name;
            videoDetails.textContent = `Details: ${video.details || 'N/A'}`;
            videoCategory.textContent = `Category: ${video.category || 'N/A'}`;
            actorCategory.textContent = `Actors: ${video.actors || 'N/A'}`;
          } else {
            videoTitle.textContent = 'Video not found';
          }

          fetchRelatedVideos(videos);
        })
        .catch(error => {
          console.error('Error loading video details:', error);
        });
    }

    function fetchRelatedVideos(allVideos) {
      const relatedVideos = getRandomVideos(allVideos, 8);
      relatedVideosGrid.innerHTML = '';

      relatedVideos.forEach(video => {
        const videoItem = document.createElement('div');
        videoItem.classList.add('video-item');
        videoItem.innerHTML = `
          <a href="video.html?id=${video.id}">
            <img src="${video.thumbnail}" alt="${video.name}">
            <h3>${video.name}</h3>
          </a>`;
        relatedVideosGrid.appendChild(videoItem);
      });
    }

    function getRandomVideos(videos, count) {
      const currentDay = new Date().getDate();
      const seed = currentDay; // use the current day as the seed for randomness
      const shuffled = videos.slice().sort(() => 0.5 - Math.random(seed));
      return shuffled.slice(0, count);
    }

    function parseCSV(text) {
      const lines = text.split('\n').filter(line => line.trim());
      const headers = lines[0].split(',').map(header => header.trim());
      const result = [];

      for (let i = 1; i < lines.length; i++) {
        const currentline = lines[i].split(',').map(value => value.trim());
        if (currentline.length === headers.length) {
          const obj = {};
          for (let j = 0; j < headers.length; j++) {
            obj[headers[j]] = currentline[j];
          }
          result.push(obj);
        }
      }

      return result;
    }

    function handleSearch() {
      const query = searchInput.value.toLowerCase();
      fetch('https://raw.githubusercontent.com/Sarker5523/My-Playlists/main/tv_series.csv')
        .then(response => response.text())
        .then(text => {
          const data = parseCSV(text);
          const filteredVideos = data.reduce((acc, video) => {
            if (video.name.toLowerCase().includes(query)) {
              const existing = acc.find(v => v.id === video.id);
              if (existing) {
                existing.episodes.push({
                  episode_id: video.episode_id,
                  name: video.episode_name,
                  embed_code: video.embed_code
                });
              } else {
                acc.push({
                  id: video.id,
                  name: video.name,
                  thumbnail: video.thumbnail,
                  episodes: [{
                    episode_id: video.episode_id,
                    name: video.episode_name,
                    embed_code: video.embed_code
                  }]
                });
              }
            }
            return acc;
          }, []);

          // Sort filtered videos by id in descending order
          allVideos = filteredVideos.sort((a, b) => b.id - a.id);

          renderVideos();
          renderPagination();
        });
    }

    function handleEnter(event) {
      if (event.key === "Enter") {
        handleSearch();
      }
    }

    fetchVideoDetails();
  </script>

</body>
</html>
