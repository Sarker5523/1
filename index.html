<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' 'unsafe-inline';
    style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com;
    img-src * data: https:;
    media-src *;
  ">
  <title>VideoHub</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.5.2/flowbite.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="styles.css">
</head>
<body>

  <!-- Navbar -->
  <nav>
    <div class="max-w-screen-xl flex flex-wrap items-center justify-between mx-auto p-4">
      <a href="index.html" class="flex items-center space-x-3">
        <img src="https://flowbite.com/docs/images/logo.svg" class="h-8 w-auto" alt="VideoHub Logo" />
        <span class="self-center text-2xl font-semibold whitespace-nowrap">VideoHub</span>
      </a>
      <div class="flex md:order-2 space-x-3">
        <button type="button" data-collapse-toggle="navbar-search" aria-controls="navbar-search"
                class="md:hidden text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-4 focus:ring-green-300 rounded-lg text-sm p-2.5">
          <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20">
            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="m19 19-4-4m0-7A7 7 0 1 1 1 8a7 7 0 0 1 14 0Z"/>
          </svg>
        </button>
        <div class="relative hidden md:block">
          <div class="absolute inset-y-0 start-0 flex items-center ps-3 pointer-events-none">
            <svg class="w-4 h-4 text-gray-500 dark:text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20">
              <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="m19 19-4-4m0-7A7 7 0 1 1 1 8a7 7 0 0 1 14 0Z"/>
            </svg>
          </div>
          <input type="text" id="search-navbar"
                 class="block w-full p-2 ps-10 text-sm text-gray-900 border border-gray-300 rounded-lg bg-gray-50 focus:ring-green-500 focus:border-green-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-green-500 dark:focus:border-green-500"
                 placeholder="Search videos, performers, studios..." oninput="debouncedSearch()">
          <div id="search-suggestions" class="search-suggestions hidden"></div>
        </div>
        <button data-collapse-toggle="navbar-search" type="button"
                class="inline-flex items-center p-2 w-10 h-10 justify-center text-sm text-gray-500 rounded-lg md:hidden hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-200 dark:text-gray-400 dark:hover:bg-gray-700 dark:focus:ring-gray-600">
          <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 17 14">
            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M1 1h15M1 7h15M1 13h15"/>
          </svg>
        </button>
      </div>

      <div class="items-center justify-between hidden w-full md:flex md:w-auto md:order-1" id="navbar-search">
        <div class="relative mt-3 md:hidden">
          <div class="absolute inset-y-0 start-0 flex items-center ps-3 pointer-events-none">
            <svg class="w-4 h-4 text-gray-500 dark:text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20">
              <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="m19 19-4-4m0-7A7 7 0 1 1 1 8a7 7 0 0 1 14 0Z"/>
            </svg>
          </div>
          <input type="text" id="search-navbar-mobile"
                 class="block w-full p-2 ps-10 text-sm text-gray-900 border border-gray-300 rounded-lg bg-gray-50 focus:ring-green-500 focus:border-green-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-green-500 dark:focus:border-green-500"
                 placeholder="Search..." oninput="debouncedSearch()">
          <div id="search-suggestions-mobile" class="search-suggestions hidden"></div>
        </div>
        <ul class="flex flex-col p-4 md:p-0 mt-4 font-medium border border-gray-100 rounded-lg bg-gray-50 md:space-x-8 md:flex-row md:mt-0 md:border-0 md:bg-white dark:bg-gray-800 md:dark:bg-gray-900 dark:border-gray-700">
          <li><a href="index.html" class="block py-2 px-3 text-white bg-green-700 rounded md:bg-transparent md:text-green-700 md:p-0">Home</a></li>
          <li><a href="studio.html" class="block py-2 px-3 text-gray-900 rounded hover:bg-gray-100 md:hover:bg-transparent md:hover:text-green-700 md:p-0 dark:text-white dark:hover:bg-gray-700">Studio</a></li>
          <li><a href="performer.html" class="block py-2 px-3 text-gray-900 rounded hover:bg-gray-100 md:hover:bg-transparent md:hover:text-green-700 md:p-0 dark:text-white dark:hover:bg-gray-700">Performers</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Pagination Top -->
  <div class="pagination" id="pagination-top"></div>

  <!-- Video Grid -->
  <div class="video-list-container">
    <div class="video-list" id="video-list"></div>
  </div>

  <!-- Pagination Bottom -->
  <div class="pagination" id="pagination-bottom"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.5.2/flowbite.min.js"></script>
  <script>
    const itemsPerPage = 10;
    let allVideos = [];
    let filteredVideos = [];
    let currentPage = 1;

    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has('page')) currentPage = Math.max(1, parseInt(urlParams.get('page')) || 1);

    const videoList = document.getElementById('video-list');
    const paginationTop = document.getElementById('pagination-top');
    const paginationBottom = document.getElementById('pagination-bottom');
    const searchInput = document.getElementById('search-navbar');
    const searchInputMobile = document.getElementById('search-navbar-mobile');
    const searchSuggestions = document.getElementById('search-suggestions');
    const searchSuggestionsMobile = document.getElementById('search-suggestions-mobile');
    let searchTimeout;

    // === Load scene_details.json ===
    async function loadData() {
      try {
        const res = await fetch('scene_details.json');
        if (!res.ok) throw new Error('scene_details.json not found');
        const data = await res.json();

        allVideos = data.map(item => ({
          id: item.data._id,
          video_Id: item.video_Id,
          title: (item.data.title || 'Untitled').trim(),
          thumbnail: item.data.background?.full || 'https://via.placeholder.com/300x200?text=No+Image',
          actressName: item.data.performers?.[0]?.name?.trim() || 'Unknown'
        }));

        // CHANGE: Reverse order → newest (last in JSON) first
        allVideos.reverse();

        filteredVideos = [...allVideos];
        renderPage();
        renderPagination();
      } catch (err) {
        videoList.innerHTML = `<p class="text-red-400 p-4">Error: ${err.message}</p>`;
      }
    }

    // === Render Grid ===
    function renderPage() {
      const start = (currentPage - 1) * itemsPerPage;
      const end = start + itemsPerPage;
      const pageVideos = filteredVideos.slice(start, end);

      videoList.innerHTML = '';
      if (pageVideos.length === 0) {
        videoList.innerHTML = '<p class="text-gray-400 p-4">No videos found.</p>';
        return;
      }

      pageVideos.forEach(v => {
        const div = document.createElement('div');
        div.className = 'video-item';
        div.innerHTML = `
          <a href="video.html?id=${v.id}">
            <img src="${v.thumbnail}" alt="${v.title}"
                 onerror="this.src='https://via.placeholder.com/300x200?text=No+Image'">
            <h3>${v.title}</h3>
            <div class="actress-box">${v.actressName}</div>
          </a>`;
        videoList.appendChild(div);
      });
    }

    // === Pagination ===
    function renderPagination() {
      const totalPages = Math.ceil(filteredVideos.length / itemsPerPage);
      [paginationTop, paginationBottom].forEach(container => {
        container.innerHTML = '';
        if (totalPages <= 1) return;

        const max = 5;
        let start = Math.max(1, currentPage - Math.floor(max / 2));
        let end = Math.min(totalPages, start + max - 1);
        if (end - start < max - 1) start = Math.max(1, end - max + 1);

        const btn = (page, text, disabled = false, active = false) => {
          const a = document.createElement('a');
          a.href = disabled ? '#' : `index.html?page=${page}`;
          a.textContent = text;
          if (active) a.classList.add('active');
          if (disabled) a.classList.add('disabled');
          return a;
        };

        if (currentPage > 1) container.appendChild(btn(currentPage - 1, 'Prev'));
        for (let i = start; i <= end; i++) container.appendChild(btn(i, i, false, i === currentPage));
        if (currentPage < totalPages) container.appendChild(btn(currentPage + 1, 'Next'));
      });
    }

    // === Search ===
    function debouncedSearch() {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(handleSearch, 300);
    }

    function handleSearch() {
      const query = (searchInput?.value || searchInputMobile?.value || '').trim().toLowerCase();
      if (!query) {
        filteredVideos = [...allVideos];
        currentPage = 1;
        renderPage();
        renderPagination();
        hideSuggestions();
        return;
      }

      filteredVideos = allVideos.filter(v =>
        v.title.toLowerCase().includes(query) ||
        v.actressName.toLowerCase().includes(query)
      );

      currentPage = 1;
      renderPage();
      renderPagination();
      showSuggestions(query);
    }

    function showSuggestions(query) {
      const results = allVideos
        .filter(v => v.title.toLowerCase().includes(query) || v.actressName.toLowerCase().includes(query))
        .slice(0, 5);

      const render = (container) => {
        container.innerHTML = results.length === 0
          ? '<div class="p-2 text-sm text-gray-400">No results</div>'
          : results.map(v => `
              <div onclick="window.location.href='video.html?id=${v.id}'">
                <img src="${v.thumbnail}" alt="${v.title}"
                     onerror="this.src='https://via.placeholder.com/40x40?text=No+Image'">
                <div>
                  <div class="text-sm font-medium truncate">${v.title}</div>
                  <div class="text-xs text-green-400">${v.actressName}</div>
                </div>
              </div>
            `).join('');
        container.classList.toggle('hidden', results.length === 0);
      };

      render(searchSuggestions);
      render(searchSuggestionsMobile);
    }

    function hideSuggestions() {
      searchSuggestions.classList.add('hidden');
      searchSuggestionsMobile.classList.add('hidden');
    }

    // Sync desktop/mobile inputs
    searchInput?.addEventListener('input', () => {
      if (searchInputMobile) searchInputMobile.value = searchInput.value;
      debouncedSearch();
    });
    searchInputMobile?.addEventListener('input', () => {
      if (searchInput) searchInput.value = searchInputMobile.value;
      debouncedSearch();
    });

    // Enter → go to search.html
    document.addEventListener('keydown', e => {
      if (e.key === 'Enter' && (document.activeElement === searchInput || document.activeElement === searchInputMobile)) {
        const q = (searchInput?.value || searchInputMobile?.value || '').trim();
        if (q) window.location.href = `search.html?query=${encodeURIComponent(q)}`;
      }
    });

    // === Init ===
    loadData();
  </script>
</body>
</html>
