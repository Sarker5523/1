<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdnjs.cloudflare.com;
    style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com;
    connect-src 'self' https://api.theporndb.net https://cdnjs.cloudflare.com ws://127.0.0.1:3001;
    img-src * data: https:;
    media-src *;
  ">
  <title>Home</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.5.2/flowbite.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="styles.css">
  <style>
    .skeleton { @apply bg-gray-700 animate-pulse rounded; }
    .skeleton-img { @apply w-full h-48 object-cover; }
    .skeleton-title { @apply h-6 w-3/4 mt-2; }
    .skeleton-actress { @apply h-4 w-1/2 mt-1; }
  </style>
</head>
<body class="bg-gray-900">

  <!-- Navbar (unchanged) -->
  <nav class="bg-white border-gray-200 dark:bg-gray-900">
    <div class="max-w-screen-xl flex flex-wrap items-center justify-between mx-auto p-4">
      <a href="index.html" class="flex items-center space-x-3 rtl:space-x-reverse">
        <img src="https://flowbite.com/docs/images/logo.svg" class="h-8 w-auto" alt="VideoHub Logo" />
        <span class="self-center text-2xl font-semibold whitespace-nowrap dark:text-white">VideoHub</span>
      </a>
      <div class="flex md:order-2 space-x-3 rtl:space-x-reverse">
        <button type="button" data-collapse-toggle="navbar-search" aria-controls="navbar-search" aria-expanded="false" class="md:hidden text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-4 focus:ring-green-300 rounded-lg text-sm p-2.5 me-2">
          <svg class="w-5 h-5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20">
            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m19 19-4-4m0-7A7 7 0 1 1 1 8a7 7 0 0 1 14 0Z"/>
          </svg>
          <span class="sr-only">Search</span>
        </button>
        <div class="relative hidden md:block">
          <div class="absolute inset-y-0 start-0 flex items-center ps-3 pointer-events-none">
            <svg class="w-4 h-4 text-gray-500 dark:text-gray-400" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20">
              <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m19 19-4-4m0-7A7 7 0 1 1 1 8a7 7 0 0 1 14 0Z"/>
            </svg>
          </div>
          <input type="text" id="search-navbar" class="block w-full p-2 ps-10 text-sm text-gray-900 border border-gray-300 rounded-lg bg-gray-50 focus:ring-green-500 focus:border-green-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-green-500 dark:focus:border-green-500" placeholder="Search videos, performers, studios..." oninput="handleSearch()" onkeydown="handleEnter(event)">
          <div id="search-suggestions" class="search-suggestions hidden"></div>
        </div>
        <button data-collapse-toggle="navbar-search" type="button" class="inline-flex items-center p-2 w-10 h-10 justify-center text-sm text-gray-500 rounded-lg md:hidden hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-200 dark:text-gray-400 dark:hover:bg-gray-700 dark:focus:ring-gray-600" aria-controls="navbar-search" aria-expanded="false">
          <span class="sr-only">Open main menu</span>
          <svg class="w-5 h-5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 17 14">
            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M1 1h15M1 7h15M1 13h15"/>
          </svg>
        </button>
      </div>
      <div class="items-center justify-between hidden w-full md:flex md:w-auto md:order-1" id="navbar-search">
        <div class="relative mt-3 md:hidden">
          <div class="absolute inset-y-0 start-0 flex items-center ps-3 pointer-events-none">
            <svg class="w-4 h-4 text-gray-500 dark:text-gray-400" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20">
              <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m19 19-4-4m0-7A7 7 0 1 1 1 8a7 7 0 0 1 14 0Z"/>
            </svg>
          </div>
          <input type="text" id="search-navbar-mobile" class="block w-full p-2 ps-10 text-sm text-gray-900 border border-gray-300 rounded-lg bg-gray-50 focus:ring-green-500 focus:border-green-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-green-500 dark:focus:border-green-500" placeholder="Search videos, performers, studios..." oninput="handleSearch()" onkeydown="handleEnter(event)">
          <div id="search-suggestions-mobile" class="search-suggestions hidden"></div>
        </div>
        <ul class="flex flex-col p-4 md:p-0 mt-4 font-medium border border-gray-100 rounded-lg bg-gray-50 md:space-x-8 rtl:space-x-reverse md:flex-row md:mt-0 md:border-0 md:bg-white dark:bg-gray-800 md:dark:bg-gray-900 dark:border-gray-700">
          <li><a href="index.html" class="block py-2 px-3 text-white bg-green-700 rounded-md md:bg-transparent md:text-green-700 md:p-0 md:dark:text-green-500" aria-current="page">Home</a></li>
          <li><a href="studio.html" class="block py-2 px-3 text-gray-900 rounded-md hover:bg-gray-100 md:hover:bg-transparent md:hover:text-green-700 md:p-0 md:dark:hover:text-green-500 dark:text-white dark:hover:bg-gray-700 dark:hover:text-white md:dark:hover:bg-transparent dark:border-gray-700">Studio</a></li>
          <li><a href="performers.html" class="block py-2 px-3 text-gray-900 rounded-md hover:bg-gray-100 md:hover:bg-transparent md:hover:text-green-700 md:p-0 md:dark:hover:text-green-500 dark:text-white dark:hover:bg-gray-700 dark:hover:text-white md:dark:hover:bg-transparent dark:border-gray-700">Performers</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="pagination" id="pagination-top"></div>
  <div class="video-list-container">
    <div class="video-list" id="video-list"></div>
  </div>
  <div class="pagination" id="pagination-bottom"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.5.2/flowbite.min.js"></script>
  <script>
    const API_TOKEN = 'Bearer Aor5JIDSkxOhmXmNAOYP5Gnr73u7u3UPJZYaevBT2558d467';
    const itemsPerPage = 10;
    const CACHE_TTL = 24 * 60 * 60 * 1000; // 24h
    const MAX_RETRIES = 3;
    const RETRY_DELAY_BASE = 200; // ms
    const urlParams = new URLSearchParams(window.location.search);
    let currentPage = parseInt(urlParams.get('page')) || 1;
    let allVideos = [];
    let videoById = new Map();
    let db = null;
    let searchTimeout;

    const searchInput = document.getElementById('search-navbar');
    const searchInputMobile = document.getElementById('search-navbar-mobile');
    const searchSuggestions = document.getElementById('search-suggestions');
    const searchSuggestionsMobile = document.getElementById('search-suggestions-mobile');
    const videoListContainer = document.getElementById('video-list');
    const paginationTop = document.getElementById('pagination-top');
    const paginationBottom = document.getElementById('pagination-bottom');

    /* --------------------------------------------------------------
       IndexedDB Cache
    -------------------------------------------------------------- */
    function initDB() {
      return new Promise((resolve, reject) => {
        const req = indexedDB.open('VideoHubCache', 1);
        req.onerror = () => reject(req.error);
        req.onsuccess = () => { db = req.result; resolve(db); };
        req.onupgradeneeded = e => {
          const db = e.target.result;
          if (!db.objectStoreNames.contains('videos')) {
            db.createObjectStore('videos', { keyPath: 'id' }).createIndex('timestamp', 'timestamp');
          }
        };
      });
    }

    async function getFromCache(id) {
      if (!db) return null;
      return new Promise(resolve => {
        const tx = db.transaction('videos', 'readonly');
        const req = tx.objectStore('videos').get(id);
        req.onsuccess = () => {
          const d = req.result;
          if (d && Date.now() - d.timestamp < CACHE_TTL) resolve(d);
          else {
            if (d) db.transaction('videos', 'readwrite').objectStore('videos').delete(id);
            resolve(null);
          }
        };
        req.onerror = () => resolve(null);
      });
    }

    async function putToCache(id, data) {
      if (!db) return;
      db.transaction('videos', 'readwrite').objectStore('videos')
        .put({ ...data, id, timestamp: Date.now() });
    }

    /* --------------------------------------------------------------
       Fast + Retry fetch for a single scene
    -------------------------------------------------------------- */
    async function fetchSceneWithRetry(id, attempt = 1) {
      try {
        const res = await fetch(`https://api.theporndb.net/scenes/${id}?add_to_collection=true`, {
          headers: { 'accept': 'application/json', 'Authorization': API_TOKEN },
          keepalive: true,
          cache: 'no-store'
        });
        if (res.ok) return await res.json();
      } catch (err) {
        console.warn(`[Retry ${attempt}/${MAX_RETRIES}] Scene ${id} failed:`, err);
      }

      if (attempt >= MAX_RETRIES) {
        console.error(`Scene ${id} failed after ${MAX_RETRIES} retries`);
        return null;
      }

      const delay = RETRY_DELAY_BASE * (2 ** (attempt - 1));
      await new Promise(r => setTimeout(r, delay));
      return fetchSceneWithRetry(id, attempt + 1);
    }

    /* --------------------------------------------------------------
       Enrich page – parallel + retry
    -------------------------------------------------------------- */
    async function enrichPageParallel(pageVideos) {
      const cacheResults = await Promise.all(pageVideos.map(v => getFromCache(v.id)));

      const toFetch = [];
      const enriched = [];

      for (let i = 0; i < pageVideos.length; i++) {
        if (cacheResults[i]) {
          applySceneData(pageVideos[i], cacheResults[i]);
          enriched[i] = cacheResults[i];
        } else {
          toFetch.push(pageVideos[i]);
          enriched[i] = null;
        }
      }

      if (toFetch.length === 0) return;

      // Parallel + retry
      const fetchPromises = toFetch.map(v => fetchSceneWithRetry(v.id));
      const responses = await Promise.all(fetchPromises);

      let fetchIdx = 0;
      for (let i = 0; i < pageVideos.length; i++) {
        if (enriched[i]) continue;

        const json = responses[fetchIdx++];
        const scene = json?.data;
        if (!scene) continue; // skip after retries

        const payload = { scene, performer: scene.performers?.[0] || null };
        applySceneData(pageVideos[i], payload);
        await putToCache(pageVideos[i].id, payload);
      }
    }

    function applySceneData(video, payload) {
      const s = payload.scene;
      const p = payload.performer;

      video.title = (s?.title || '').trim() || 'Untitled Video';
      video.thumbnail = s?.background?.full || 'https://via.placeholder.com/300x200?text=No+Image';
      video.actressName = (p?.name || '').trim() || 'Unknown';
      video.description = s?.description || 'No description';
      video.url = s?.url || '#';
      video.trailer = s?.trailer || '';
      video.site = {
        id: s?.site?.id || 0,
        name: s?.site?.name || 'Unknown Studio',
        short_name: s?.site?.short_name || 'Unknown',
        rating: s?.site?.rating || 0,
        logo: s?.site?.logo || '',
        parent: s?.site?.parent || { id: 0, name: 'Unknown', short_name: 'Unknown' }
      };
    }

    /* --------------------------------------------------------------
       Load video.json → minimal objects
    -------------------------------------------------------------- */
    async function loadVideos() {
      try {
        const res = await fetch('video.json');
        if (!res.ok) throw new Error(`video.json ${res.status}`);
        const json = await res.json();

        allVideos = json.videos.map(v => {
          const video = {
            id: v.data._id,
            title: null, thumbnail: null, actressName: null,
            description: '', url: '#', trailer: '',
            site: { id: 0, name: '', short_name: '', rating: 0, logo: '', parent: { id: 0, name: '', short_name: '' } },
            performers: v.data.performers?.map(p => p._id) || []
          };
          videoById.set(video.id, video);
          return video;
        });

        allVideos.reverse();
        await initDB();
        renderPagination();
        await renderCurrentPage();
      } catch (e) {
        console.error(e);
        videoListContainer.innerHTML = '<p class="text-red-400 p-4">Failed to load videos.</p>';
      }
    }

    /* --------------------------------------------------------------
       Render current page – skeleton → real data
    -------------------------------------------------------------- */
    async function renderCurrentPage() {
      const start = (currentPage - 1) * itemsPerPage;
      const end = start + itemsPerPage;
      const pageVideos = allVideos.slice(start, end);

      if (!pageVideos.length) {
        videoListContainer.innerHTML = '<p class="text-gray-400 p-4">No videos found.</p>';
        return;
      }

      renderSkeleton(pageVideos.length);
      await enrichPageParallel(pageVideos);
      renderRealVideos(pageVideos.filter(v => v.title && v.thumbnail));
    }

    function renderSkeleton(count) {
      videoListContainer.innerHTML = '';
      for (let i = 0; i < count; i++) {
        const div = document.createElement('div');
        div.className = 'video-item';
        div.innerHTML = `
          <a href="#" class="block">
            <div class="skeleton skeleton-img"></div>
            <div class="skeleton skeleton-title"></div>
            <div class="skeleton skeleton-actress"></div>
          </a>`;
        videoListContainer.appendChild(div);
      }
    }

    function renderRealVideos(videos) {
      videoListContainer.innerHTML = '';
      videos.forEach(v => {
        const div = document.createElement('div');
        div.className = 'video-item';
        div.innerHTML = `
          <a href="video.html?id=${v.id}">
            <img src="${v.thumbnail}" alt="${v.title}" class="w-full h-48 object-cover rounded-t-lg"
                 onerror="this.src='https://via.placeholder.com/300x200?text=Image+Failed'">
            <h3 class="text-lg font-semibold text-white mt-2 truncate">${v.title}</h3>
            <div class="actress-box text-sm text-green-400">${v.actressName}</div>
          </a>`;
        videoListContainer.appendChild(div);
      });
    }

    /* --------------------------------------------------------------
       Pagination
    -------------------------------------------------------------- */
    function renderPagination() {
      const total = Math.ceil(allVideos.length / itemsPerPage);
      [paginationTop, paginationBottom].forEach(el => {
        el.innerHTML = '';
        const max = 7;
        let start = Math.max(1, currentPage - Math.floor(max / 2));
        let end = Math.min(total, start + max - 1);
        if (end - start < max - 1) start = Math.max(1, end - max + 1);

        const btn = (page, txt = page, disabled = false, active = false) => {
          const a = document.createElement('a');
          a.innerText = txt;
          if (!disabled) {
            a.href = `?page=${page}`;
            a.onclick = e => {
              e.preventDefault();
              currentPage = page;
              history.pushState({}, '', `?page=${page}`);
              renderCurrentPage();
              renderPagination();
            };
          }
          if (active) a.classList.add('active');
          if (disabled) a.classList.add('disabled');
          return a;
        };

        if (currentPage > 1) el.appendChild(btn(currentPage - 1, 'Prev'));
        for (let i = start; i <= end; i++) el.appendChild(btn(i, i, false, i === currentPage));
        if (currentPage < total) el.appendChild(btn(currentPage + 1, 'Next'));
      });
    }

    /* --------------------------------------------------------------
       Search
    -------------------------------------------------------------- */
    function syncSearchInputs(src) {
      if (src === searchInput && searchInputMobile) searchInputMobile.value = src.value;
      if (src === searchInputMobile && searchInput) searchInput.value = src.value;
    }

    function debouncedSearch() {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(handleSearch, 300);
    }

    function handleSearch() {
      const q = (searchInput?.value || searchInputMobile?.value || '').trim().toLowerCase();
      if (!q) {
        [searchSuggestions, searchSuggestionsMobile].forEach(s => s.classList.add('hidden'));
        return;
      }

      const results = allVideos
        .filter(v => v.title && (
          v.title.toLowerCase().includes(q) ||
          v.site?.name?.toLowerCase().includes(q) ||
          v.actressName?.toLowerCase().includes(q)
        ))
        .slice(0, 5);

      const render = (container, list) => {
        container.innerHTML = list.length
          ? list.map(v => `
              <div class="flex items-center p-2 cursor-pointer hover:bg-gray-700"
                   onclick="window.location.href='video.html?id=${v.id}'">
                <img src="${v.thumbnail}" alt="${v.title}" class="w-10 h-10 rounded mr-2 object-cover"
                     onerror="this.src='https://via.placeholder.com/300x200?text=No+Image'">
                <span class="text-white text-sm">${v.title}</span>
              </div>`).join('')
          : '<div class="p-2 text-white text-sm">No results</div>';
        container.classList.toggle('hidden', list.length === 0);
      };

      render(searchSuggestions, results);
      render(searchSuggestionsMobile, results);
    }

    function handleEnter(e) {
      if (e.key === 'Enter') {
        const q = (searchInput?.value || searchInputMobile?.value || '').trim();
        if (q) window.location.href = `search.html?query=${encodeURIComponent(q)}`;
        [searchSuggestions, searchSuggestionsMobile].forEach(s => s.classList.add('hidden'));
      }
    }

    /* --------------------------------------------------------------
       Init
    -------------------------------------------------------------- */
    loadVideos();

    searchInput?.addEventListener('input', () => { debouncedSearch(); syncSearchInputs(searchInput); });
    searchInputMobile?.addEventListener('input', () => { debouncedSearch(); syncSearchInputs(searchInputMobile); });
  </script>
</body>
</html>
